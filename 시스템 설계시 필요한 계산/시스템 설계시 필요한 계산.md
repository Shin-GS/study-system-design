# 시스템 설계 시 필요한 계산(Back‑of‑the‑Envelope)

## 기본 단위
- 바이트 단위(이진수):
  - 1 KB = 1,024 B, 1 MB = 1,048,576 B, 1 GB = 1,073,741,824 B, 1 TB ≈ 1.10×10¹² B【90†system_design_2】
- 시간/빈도:
  - 1분 = 60초, 1시간 = 3,600초, 1일 = 86,400초
- 네트워크 표기:
  - **b(비트)** vs **B(바이트)** 구분 (1 B = 8 b)
  - 1 Gbps ≈ 125 MB/s (= 1,000 Mb/s ÷ 8) — 대역폭↔전송시간 계산에 필수
- 로그/지표 관례:
  - P50/P95/P99 지연시간, 에러율(%), 가용성(%) 등

---

## 1) 트래픽 규모 추정 (Users → QPS/TPS)
1) 활성 사용자 추정  
- MAU → DAU: 보수적으로 **DAU ≈ MAU × 0.1~0.2**  
- 동시 접속자(peak concurrent): **DAU × 동시성 계수(1~10%)**
2) 요청 빈도 가정  
- 1 사용자당 초당 평균 요청 r req/s
3) **QPS** 근사:  
- **QPS ≈ 동시 접속자 × r**
4) **TPS**(트랜잭션): 페이지/액션당 트랜잭션 수로 환산

**예시**  
- MAU 5,000,000 → DAU 1,000,000(20%) → 동시접속 5%(= 50,000명)  
- r = 0.2 req/s → **QPS ≈ 10,000**

---

## 2) 용량(저장소) 추정
1) **객체 크기**: 레코드/이미지/로그 1건의 평균 바이트 수 k  
2) **일일 생성량**: N건/일  
3) **일일 증가 용량**: **N × k**  
4) **보존 기간**: d일 → **총 용량 ≈ N × k × d** (+ 인덱스/압축 여유 1.2~2.0×)

**예시**  
- 이벤트 2×10⁹건/일, 300 B/건(압축 후) → 600 GB/일  
- 90일 보존 + 1.5× 여유 → **약 81 TB**

---

## 3) 네트워크/전송 시간 계산
- **전송 시간(초) ≈ 데이터크기(B) ÷ 처리량(B/s)**  
- 처리량(B/s) = **대역폭(bps) ÷ 8 × 효율계수**(0.7~0.9)

**예시**  
- 1 TB(≈ 1.10×10¹² B)를 1 Gbps(125 MB/s) 링크에서 효율 0.8로 전송  
- 처리량 ≈ 100 MB/s → **약 3.0시간**  

---

## 4) 지연시간 예산(Latency Budget)
- **End‑to‑End 지연 = LB + App + DB + 외부호출 + Serialize/Network**
- 목표 SLO(P50/P95/P99)를 각 구간에 배분; p99는 꼬리 지연을 고려해 여유 2~3×
- **N+1 쿼리**나 일련의 연쇄 호출 체인의 합산에 주의

**예시 예산(p95 300ms)**  
- LB 30ms, App 80ms, DB 120ms, 외부 50ms, 기타 20ms

---

## 5) 캐시 효과 추정
- **평균 지연 ≈ hit_ratio × L_hit + (1 − hit_ratio) × L_miss**
- **원본 부하 감소율 ≈ hit_ratio**
- **Stampede 위험**: hot key TTL 동시 만료 시 QPS 폭주 → soft TTL/lock

**예시**  
- L_hit 5ms, L_miss 50ms, hit 0.9 → 평균 10ms

---

## 6) 복제/샤딩 규모
- **복제 팩터 RF**: 저장 총량 = 원본 × RF (예: RF=3 → 3배)  
- **샤딩 수 S**: 파티션당 목표 크기/부하 기준으로 **S ≈ 총량 ÷ 목표량**  
- 샤드 재밸런싱 비용 = 데이터 이동량 ÷ 네트워크 처리량(시간)

**예시**  
- 총 60 TB, 샤드당 2 TB → **S = 30샤드**

---

## 7) 큐/스트리밍 처리량
- **리틀의 법칙**: L = λ × W  
  - 큐 길이 L(건) = 유입률 λ(건/s) × 평균 대기/처리시간 W(초)
- **소비자 수 확장**: 처리량 ≈ 소비자수 × 1인당 처리율

**예시**  
- 유입 20k msg/s, 1 워커 2k msg/s → **10 워커 필요** (+ 여유 20%)

---

## 8) 에러예산/가용성
- 연간 99.9% 가용성 → **허용 다운타임 ≈ 8.76시간/년**
- 월간 99.5% → **≈ 3.6시간/월**
- **SLO 위반 추적**: 에러율·타임아웃·서킷오픈의 누적 시간을 예산과 비교

---

## 9) 읽기/쓰기 비율 & DB QPS
- **읽기:쓰기 = R:W**, 쓰기 확장에는 파티션/배치·CQRS 고려  
- DB 커넥션 풀 한계: 동시 쿼리 수 × 평균 쿼리 시간 → **최대 QPS** 상한
- 인덱스/트랜잭션 오버헤드(쓰기 증폭)에 1.5~3× 여유

**예시**  
- 평균 쿼리 10ms, 동시 200 → **이론상 20k QPS** (실효 10~12k)

---

## 10) 로그/관측 데이터 볼륨
- **로그 이벤트 크기 k_log × 이벤트 수 N_log/일 → GB/일**
- 압축 3~10×, 보존 7~30일 핫 + 3~12개월 콜드
- 색인/메타데이터 오버헤드 1.3~2.0×

---

## 11) 비용 근사
- 월 트래픽 아웃(GB) × 단가 + 요청 수 × 단가 + 스토리지(GB‑mo) × 단가
- **캐시/압축/버전 관리**로 egress 절감 → CDN/엣지 활용

---

## 12) 면접/설계 스니펫
- **사용자 규모 → QPS**: MAU/DAU/동시성 → QPS 산출 → LB/앱/DB 용량 배분【90†system_design_2】  
- **데이터 사이징**: 이벤트 크기/일일 건수/보존 → 총 TB → RF/백업 반영  
- **전송/마이그레이션 시간**: TB ÷ (Gbps/8 × 효율) → 마이그/컷오버 계획【90†system_design_2】

---

## 13) 치트시트 (암산용 근사)
- 1 Gbps ≈ 125 MB/s → 1 TB ≈ **~2.2~3.0시간**(효율 0.6~0.8)
- 10 ms/요청 → 이론상 1 스레드 **100 rps**
- 1억(1e8) × 100 B ≈ 10 GB, 1e9 × 1 KB ≈ ~1 TB
- 99.9% ≈ 8.76 h/yr, 99.95% ≈ 4.38 h/yr, 99.99% ≈ 52.6 min/yr

---

## 14) 템플릿 (복붙용)
```md
### 요구사항 요약
- DAU: __, 동시성: __%, r(req/s): __ → 예상 QPS: __
- 읽기:쓰기 = __:__ → 읽기 QPS __, 쓰기 QPS __

### 저장소 사이징
- 이벤트 크기: __ B, 생성량: __ 건/일 → __ GB/일
- 보존: __ 일, 여유계수: __ × → 총 __ TB (RF __ → __ TB)

### 네트워크/전송
- 전송량: __ TB, 링크: __ Gbps, 효율 __ → 시간 __ h

### 지연 예산(p95 __ ms)
- LB __, App __, DB __, 외부 __, 기타 __

### 캐시
- 예상 hit: __ %, L_hit __ ms, L_miss __ ms → 평균 __ ms

### 큐/스트리밍
- 유입 __ msg/s, 워커 처리량 __ msg/s → 워커 __ (+여유 __ %)
```
